{% extends 'base.html' %}
{% load static %}

{% block title %}View/Edit Bill{% endblock %}

{% block main_content %}
<main class="mt-24 bg-red-50 min-h-screen w-full p-4">
    <div class="max-w-3xl mx-auto bg-white p-6 rounded shadow">
        <h1 class="text-2xl font-bold text-center text-blue-600 mb-6">View/Edit Bill</h1>

        <!-- Patient Info -->
        <div class="grid grid-cols-2 gap-4 mb-6">
            <div>
                <label class="block text-sm font-medium text-gray-700">Patient Name</label>
                <input type="text" readonly value="{{ patient.name }}"
                       class="w-full border bg-gray-100 px-3 py-2 rounded">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Appointment</label>
                <input type="text" readonly value="{{ patient.datetime|date:'Y-m-d H:i' }}"
                       class="w-full border bg-gray-100 px-3 py-2 rounded">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Reference</label>
                <input type="text" readonly value="{{ patient.reference }}"
                       class="w-full border bg-gray-100 px-3 py-2 rounded">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Bill Total</label>
                <input type="text" readonly id="bill-total"
                       class="w-full border bg-gray-100 px-3 py-2 rounded font-bold text-red-600"
                       value="₹{{ bill.total_amount }}">
            </div>
        </div>

        <!-- Edit Bill Items -->
        <form method="post">
            {% csrf_token %}
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Edit Bill Items</label>
                <table class="w-full border text-sm">
                    <thead class="bg-gray-100">
                    <tr>
                        <th class="p-2 text-left">Product</th>
                        <th class="p-2 text-left">Amount</th>
                        <th class="p-2 text-center">Action</th>
                    </tr>
                    </thead>
                    <tbody id="product-lines">
                    {% for item in items %}
                    <tr>
                        <td class="p-2">
                            <select name="product[]" class="w-full border px-2 py-1 rounded">
                                {% for product in products %}
                                <option value="{{ product.id }}" data-amount="{{ product.price }}"
                                        {% if product.id== item.product.id %}selected{% endif %}>
                                    {{ product.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </td>
                        <td class="p-2">
                            <input type="number" name="amount[]" value="{{ item.amount }}"
                                   readonly class="w-full border px-2 py-1 rounded">
                        </td>
                        <td class="p-2 text-center">
                            <button type="button" onclick="removeLine(this)" class="text-red-600 font-bold">&times;
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                    </tbody>
                </table>
                <button type="button" onclick="addLine()"
                        class="mt-2 bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600">+ Add Item
                </button>
            </div>

            <div class="text-center">
                <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">Save Changes
                </button>
            </div>
        </form>
    </div>
</main>
{% endblock %}

{% block scripts %}
<script>
    function updateAmountFromSelect(selectElement) {
        const selectedOption = selectElement.options[selectElement.selectedIndex];
        const amount = selectedOption.getAttribute("data-amount") || 0;
        const amountInput = selectElement.closest('tr').querySelector('input[name="amount[]"]');
        amountInput.value = amount;
        updateTotal();
    }

    function addLine() {
        const row = document.querySelector('#product-lines tr');
        const clone = row.cloneNode(true);

        const select = clone.querySelector('select');
        const input = clone.querySelector('input[name="amount[]"]');

        input.value = "";
        select.selectedIndex = 0;

        // Bind event again
        select.addEventListener('change', function () {
            updateAmountFromSelect(this);
        });

        // Append and initialize
        document.querySelector('#product-lines').appendChild(clone);
        updateAmountFromSelect(select);
        updateTotal();
    }

    function removeLine(btn) {
        const row = btn.closest('tr');
        const rows = document.querySelectorAll('#product-lines tr');
        if (rows.length > 0) {
            row.remove();
            updateTotal();
        }
    }

    function updateTotal() {
        let total = 0;
        document.querySelectorAll('input[name="amount[]"]').forEach(input => {
            const value = parseFloat(input.value) || 0;
            total += value;
        });
        const totalDisplay = document.getElementById('bill-total');
        if (totalDisplay) {
            totalDisplay.value = `₹${total.toFixed(2)}`;
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('select[name="product[]"]').forEach(select => {
            updateAmountFromSelect(select);
            select.addEventListener('change', function () {
                updateAmountFromSelect(this);
            });
        });
        updateTotal();
    });
</script>
{% endblock %}
